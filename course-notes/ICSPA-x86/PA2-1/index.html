
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../PA1/">
      
      
        <link rel="next" href="../i386/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>PA2-1 - CSNote</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    
      <link rel="stylesheet" href="https://fonts.loli.net/css?family=JetBrains Mono:400,500,600,700&display=swap">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pa2-1-note" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="CSNote" class="md-header__button md-logo" aria-label="CSNote" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CSNote
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              PA2-1
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="CSNote" class="md-nav__button md-logo" aria-label="CSNote" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    CSNote
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    index
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    OI-learning
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            OI-learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/C%2B%2B%20OOP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    C++ é¢å‘å¯¹è±¡
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Algorithm
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Algorithm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/Algorithm/STL_algorithm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    STL ç®—æ³•åº“ ref
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/Algorithm/fastpow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    å¿«é€Ÿå¹‚
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Data Structure
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Data Structure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/Data-Structure/linkedlist/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    é“¾è¡¨
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/Data-Structure/vector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    STL vector ref
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/Data-Structure/stack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    æ ˆ && å•è°ƒæ ˆ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/Data-Structure/queue/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    é˜Ÿåˆ— && å•è°ƒé˜Ÿåˆ—
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../OI-Learning/Data-Structure/hashmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    å“ˆå¸Œè¡¨
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Course Notes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Course Notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ICSPA x86 note
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            ICSPA x86 note
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PA0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PA0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PA1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PA1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    PA2-1
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    PA2-1
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nemu" class="md-nav__link">
    <span class="md-ellipsis">
      NEMU å¦‚ä½•æ‰§è¡ŒæŒ‡ä»¤ï¼Ÿ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      æ¨¡æ‹ŸæŒ‡ä»¤çš„å®ç°
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ¨¡æ‹ŸæŒ‡ä»¤çš„å®ç°">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      æ“ä½œæ•°å’Œæ“ä½œæ•°å¯»å€
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ“ä½œæ•°å’Œæ“ä½œæ•°å¯»å€">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      æ“ä½œæ•°çš„å°è£…
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modrm" class="md-nav__link">
    <span class="md-ellipsis">
      ModR/M
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sib" class="md-nav__link">
    <span class="md-ellipsis">
      SIB
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      è¿›ä¸€æ­¥çš„å°è£…
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    <span class="md-ellipsis">
      ---åˆ†éš”çº¿---
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-when-completing-pa" class="md-nav__link">
    <span class="md-ellipsis">
      Tips when completing PA
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../i386/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    i386 æŒ‡ä»¤ç»“æ„ for PA2-1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PA2-2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PA2-2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ç½‘ç»œæ”»é˜²å®æˆ˜ note
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            ç½‘ç»œæ”»é˜²å®æˆ˜ note
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network-attack-and-defense-in-action/lab01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab01
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network-attack-and-defense-in-action/lab02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab02
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network-attack-and-defense-in-action/lab03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab03
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network-attack-and-defense-in-action/lab04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab04
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network-attack-and-defense-in-action/lab05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab05
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ICS && CSAPP Labs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            ICS && CSAPP Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ICS%26%26CSAPP-Lab/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ICS%26%26CSAPP-Lab/Datalab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CSAPP Datalab
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ICS%26%26CSAPP-Lab/Bomblab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CSAPP Bomblab
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ICS%26%26CSAPP-Lab/Binalab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ICS Binalab
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Deep Learning
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Deep Learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Deep-Learning/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    intro
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nemu" class="md-nav__link">
    <span class="md-ellipsis">
      NEMU å¦‚ä½•æ‰§è¡ŒæŒ‡ä»¤ï¼Ÿ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      æ¨¡æ‹ŸæŒ‡ä»¤çš„å®ç°
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ¨¡æ‹ŸæŒ‡ä»¤çš„å®ç°">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      æ“ä½œæ•°å’Œæ“ä½œæ•°å¯»å€
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ“ä½œæ•°å’Œæ“ä½œæ•°å¯»å€">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      æ“ä½œæ•°çš„å°è£…
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modrm" class="md-nav__link">
    <span class="md-ellipsis">
      ModR/M
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sib" class="md-nav__link">
    <span class="md-ellipsis">
      SIB
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      è¿›ä¸€æ­¥çš„å°è£…
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    <span class="md-ellipsis">
      ---åˆ†éš”çº¿---
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-when-completing-pa" class="md-nav__link">
    <span class="md-ellipsis">
      Tips when completing PA
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="pa2-1-note">PA2-1 note</h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p>âœ 2746 words  | ğŸ› 545 codelines  | â° 16 min read | Enjoy ğŸ¶</p>
</div>
<div class="admonition quote">
<p class="admonition-title">å¯ä»¥å…ˆå»çœ‹ i386 çš„æŒ‡ä»¤ç»“æ„ (for PA2) äº†è§£ä¸€æ¡æŒ‡ä»¤çš„è§£æè¿‡ç¨‹</p>
</div>
<div class="admonition caution">
<p class="admonition-title">ç”±äº i386 æ‰‹å†Œä¸Šå­˜åœ¨ä¸€äº›ä¸¥é‡å½±å“PAè¿›è¡Œçš„ç¬”è¯¯ï¼Œæ‰€ä»¥è¯·æ—¶åˆ»æ³¨æ„<strong>æ‰‹å†Œæ˜¯å¦å­˜åœ¨ç¬”è¯¯</strong>ï¼ˆå°¤å…¶æ˜¯å‡ºç°éš¾ä»¥ç†è§£çš„é”™è¯¯æ—¶ï¼‰</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªä¿®æ­£åçš„ i386 æ‰‹å†Œ https://github.com/NJU-ProjectN/i386-manual </p>
<p>ä¸Šé¢çš„æ‰‹å†Œä¹Ÿä¼šå­˜åœ¨æœªä¿®æ­£çš„éƒ¨åˆ†ï¼Œä½ åº”è¯¥è¿›è¡Œä¸‰æ–¹é¢éªŒè¯ï¼š</p>
<p>**æ‰‹å†Œ - PA æ¡†æ¶ä»£ç  - <a href="http://www.felixcloutier.com/x86/" target="_blank">è¿™ä¸ªé“¾æ¥</a></p>
</div>
<div class="admonition warning">
<p class="admonition-title">æœ¬ note åŸºæœ¬ä¸ä¼šç»™å‡ºä»£ç å®ç°ï¼Œæ›´æ¥è¿‘äºå¯¹å®éªŒæ‰‹å†Œçš„è§£è¯»</p>
</div>
<h2 id="nemu">NEMU å¦‚ä½•æ‰§è¡ŒæŒ‡ä»¤ï¼Ÿ</h2>
<blockquote>
<p>æŒ‡ä»¤å¾ªç¯çš„å®ç°å¯¹åº”<code>nemu/src/cpu/cpu.c</code>ä¸­<code>void exec(uint32_t)</code>å‡½æ•°ä¸­çš„<code>while</code>å¾ªç¯ã€‚å…¶ä¸­ï¼Œ<code>exec()</code>å‡½æ•°çš„å‚æ•°ä¸ºéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤æ¡æ•°ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶ï¼ŒCPUå°†ä¸æ–­åœ°æ‰§è¡ŒæŒ‡ä»¤ã€‚</p>
<p>åœ¨<code>exec()</code>å‡½æ•°çš„<code>while</code>å¾ªç¯ä¸­ï¼Œè¯­å¥<code>len = exec_inst()</code>è°ƒç”¨äº†å‡½æ•°<code>exec_inst()</code>ã€‚é€šè¿‡é˜…è¯»ä»£ç æ³¨é‡Šï¼Œå¯ä»¥äº†è§£åˆ°<code>exec_inst()</code>å‡½æ•°çš„åŠŸèƒ½æ˜¯æ‰§è¡ŒEIPæŒ‡å‘çš„æŒ‡ä»¤ï¼Œå¹¶è¿”å›æŒ‡ä»¤çš„é•¿åº¦ã€‚</p>
</blockquote>
<p>è¿™é‡Œè´´å‡º <code>exec</code> å‡½æ•°çš„ä»£ç ï¼Œäº†è§£ NEMU å¦‚ä½•å®Œæˆå¯¹ä¸€ç³»åˆ—æŒ‡ä»¤çš„æ‰§è¡Œï¼š</p>
<div class="admonition quote">
<p class="admonition-title">è‹±æ–‡æ³¨é‡Šæ˜¯åŸç¨‹åºè‡ªå¸¦çš„ï¼Œä¸ä½œæ”¹åŠ¨</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">exec</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w">   </span><span class="c1">// uint32_t n ä½œä¸ºæŒ‡ä»¤æ¡æ•°ä¼ å…¥å‡½æ•°</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// åˆå§‹åŒ–éƒ¨åˆ†</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">BP</span><span class="w"> </span><span class="o">*</span><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">           </span><span class="c1">// BP å³ BreakPointï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å½“å‰æ–­ç‚¹çš„æŒ‡é’ˆ</span>
<span class="w">    </span><span class="n">verbose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100000</span><span class="p">);</span><span class="w">        </span><span class="c1">// ä¸€ä¸ª bool å˜é‡ï¼Œä½œç”¨å‚è€ƒåé¢çš„è¡¥å……å†…å®¹</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">instr_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">              </span><span class="c1">// å­˜å‚¨æ¯æ¡æŒ‡ä»¤çš„é•¿åº¦</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">hit_break_rerun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">   </span><span class="c1">// æ ‡è®°å½“å‰æ˜¯å¦ä¸ºâ€œä»æ–­ç‚¹çŠ¶æ€æ¢å¤æ‰§è¡Œâ€</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nemu_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NEMU_BREAK</span><span class="p">)</span><span class="w">   </span><span class="c1">// åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºâ€œä»æ–­ç‚¹çŠ¶æ€æ¢å¤æ‰§è¡Œâ€</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">hit_break_rerun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">nemu_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NEMU_RUN</span><span class="p">;</span><span class="w">          </span><span class="c1">// NEMU çš„çŠ¶æ€è¢«è®¾å®šä¸º RUNï¼ˆæ­£åœ¨è¿è¡Œï¼‰</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nemu_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NEMU_RUN</span><span class="p">)</span><span class="w">     </span><span class="c1">// é€æ¡æ‰§è¡Œç¨‹åºçš„ä¸»å¾ªç¯</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">is_nemu_hlt</span><span class="p">)</span><span class="w">                        </span><span class="c1">// HALT æ˜¯â€œåœæ­¢è¿è¡Œâ€ çš„æŒ‡ä»¤</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">instr_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec_inst</span><span class="p">();</span><span class="w">            </span><span class="c1">// æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ï¼Œå‡½æ•°çš„è¿”å›å€¼æ˜¯æŒ‡ä»¤é•¿åº¦</span>
<span class="w">            </span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">instr_len</span><span class="p">;</span><span class="w">               </span><span class="c1">// eip åœ¨è¿™é‡Œå°±æ˜¯ PC çš„å…·ä½“å®ç°</span>
<span class="w">            </span><span class="n">n</span><span class="o">--</span><span class="p">;</span><span class="w">                                </span><span class="c1">// å¾…è¿è¡ŒæŒ‡ä»¤æ•° -1</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hit_break_rerun</span><span class="p">)</span><span class="w">                </span><span class="c1">// å¦‚æœæ˜¯â€œä»æ–­ç‚¹çŠ¶æ€æ¢å¤æ‰§è¡Œâ€ï¼Œè¿›è¡Œæ¢å¤æ“ä½œ</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">resume_breakpoints</span><span class="p">();</span>
<span class="w">                </span><span class="n">hit_break_rerun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// è¿™éƒ¨åˆ†å†…å®¹æ˜¯ â€œæ–­ç‚¹æ£€æµ‹â€</span>
<span class="w">            </span><span class="c1">// check for breakpoints</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nemu_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NEMU_BREAK</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// find break in the list</span>
<span class="w">                </span><span class="n">bp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_breakpoint</span><span class="p">(</span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// found, then restore the original opcode</span>
<span class="w">                    </span><span class="n">vaddr_write</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">SREG_CS</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ori_byte</span><span class="p">);</span>
<span class="w">                    </span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="o">--</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// not found, it is triggered by BREAK_POINT in the code, do nothing</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// è¿™éƒ¨åˆ†å†…å®¹æ˜¯â€œæ ‡è®°ç‚¹æ£€æµ‹â€</span>
<span class="w">            </span><span class="c1">// check for watchpoints</span>

<span class="w">            </span><span class="n">BP</span><span class="w"> </span><span class="o">*</span><span class="n">wp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scan_watchpoint</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// print_bin_instr(eip_temp, instr_len);</span>
<span class="w">                </span><span class="c1">// puts(assembly);</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Hit watchpoint %d at address 0x%08x, expr = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">NO</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">instr_len</span><span class="p">,</span><span class="w"> </span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">expr</span><span class="p">);</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;old value = %#08x</span><span class="se">\n</span><span class="s">new value = %#08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">old_val</span><span class="p">,</span><span class="w"> </span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">new_val</span><span class="p">);</span>
<span class="w">                </span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">old_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">new_val</span><span class="p">;</span>
<span class="w">                </span><span class="n">nemu_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NEMU_READY</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è¿™é‡Œæ˜¯å¤–æ¥è®¾å¤‡çš„å¤„ç†ï¼ˆåœ¨ PA 4-2: å¤–è®¾ä¸I/O æ‰ä¼šé€šè¿‡æ·»åŠ å®å¯ç”¨ï¼‰</span>
<span class="cp">#if defined(HAS_DEVICE_TIMER) || defined(HAS_DEVICE_VGA) || defined(HAS_DEVICE_KEYBOARD) || defined(HAS_DEVICE_AUDIO)</span>
<span class="w">    </span><span class="n">do_devices</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="c1">// è¿™é‡Œæ˜¯ä¸­æ–­å¤„ç†ï¼ˆåœ¨ PA 4-1: å¼‚å¸¸å’Œä¸­æ–­çš„å“åº” æ‰ä¼šé€šè¿‡æ·»åŠ å®å¯ç”¨ï¼‰</span>
<span class="cp">#ifdef IA32_INTR</span>
<span class="w">        </span><span class="c1">// check for interrupt</span>
<span class="w">        </span><span class="n">do_intr</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nemu_state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NEMU_STOP</span><span class="p">)</span><span class="w">            </span><span class="c1">// è™šæ‹Ÿæœºåœæ­¢è¿è¡Œ</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;NEMU2 terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// è¿™é‡Œä¹Ÿæ˜¯ä¸­æ–­å¤„ç†ï¼ŒPA 4-1 ä¼šæœ‰æ›´è¯¦ç»†çš„è§£é‡Šï¼‰</span>
<span class="cp">#ifdef IA32_INTR</span>
<span class="w">        </span><span class="n">i8259_destroy</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">                        </span><span class="c1">// è™šæ‹Ÿæœºåšå¥½äº†è¿è¡Œçš„å‡†å¤‡</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">nemu_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NEMU_READY</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<details class="question">
<summary>å¦‚æœä½ æƒ³çŸ¥é“ <code>BP</code> æ˜¯ä»€ä¹ˆè‡ªå®šä¹‰çš„ç»“æ„</summary>
<p><code>BP</code> æ˜¯å®šä¹‰æ–­ç‚¹çš„æ•°æ®ç±»å‹ï¼Œå®šä¹‰äº <code>nemu/include/monitor/breakpoint.h</code>ï¼Œä½ ç°åœ¨åªéœ€è¦çŸ¥é“ <code>BP</code> è®°å½•äº†æ–­ç‚¹çš„ç›¸å…³ä¿¡æ¯å³å¯</p>
<p>ï¼ˆè¿™é‡Œæœ‰ä¸€ä¸ª TODO,ä½†æ˜¯æˆ‘æ²¡æœ‰æ‰¾åˆ° PA ä¸­éœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç çš„ä»»åŠ¡ï¼‰</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">breakpoint</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">ori_byte</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">in_use</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">NO</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span>

<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">expr</span><span class="p">;</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">old_val</span><span class="p">;</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">new_val</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">breakpoint</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* TODO: Add more member if necessary */</span>

<span class="p">}</span><span class="w"> </span><span class="n">BP</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
</details>
<details class="question">
<summary><code>verbose</code> æ˜¯ä¸ªä»€ä¹ˆå‚æ•°ï¼Ÿ</summary>
<p>è¿™ä¸ªå‚æ•°ç”¨äºæ§åˆ¶è°ƒè¯•ä¿¡æ¯çš„è¾“å…¥æƒ…å†µï¼Œæ¯”å¦‚ <code>nemu/include/cpu/instr_helper.h</code> ä¸­æœ‰:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#define decode_operand_o2a                    \</span>
<span class="cp">    opr_src.type = OPR_MEM;                   \</span>
<span class="cp">    opr_src.sreg = SREG_DS;                   \</span>
<span class="cp">    if (verbose)                              \</span>
<span class="cp">        clear_operand_mem_addr(&amp;opr_src);     \</span>
<span class="cp">    opr_src.addr = instr_fetch(eip + 1, 4);   \</span>
<span class="cp">    if (verbose)                              \</span>
<span class="cp">        opr_src.mem_addr.disp = opr_src.addr; \</span>
<span class="cp">    opr_dest.type = OPR_REG;                  \</span>
<span class="cp">    opr_dest.addr = REG_AL;                   \</span>
<span class="cp">    len += 4;</span>

<span class="cp">#define decode_operand_a2o                      \</span>
<span class="cp">    opr_dest.type = OPR_MEM;                    \</span>
<span class="cp">    opr_dest.sreg = SREG_DS;                    \</span>
<span class="cp">    if (verbose)                                \</span>
<span class="cp">        clear_operand_mem_addr(&amp;opr_dest);      \</span>
<span class="cp">    opr_dest.addr = instr_fetch(eip + 1, 4);    \</span>
<span class="cp">    if (verbose)                                \</span>
<span class="cp">        opr_dest.mem_addr.disp = opr_dest.addr; \</span>
<span class="cp">    opr_src.type = OPR_REG;                     \</span>
<span class="cp">    opr_src.addr = REG_AL;                      \</span>
<span class="cp">    len += 4;</span>
</code></pre></div></td></tr></table></div>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªå®å‡½æ•°ï¼Œ<code>verbose</code> ä¸º <code>true</code> æ—¶å¯ä»¥è¾“å‡ºæ›´å¤šå…³äºå†…å­˜æ“ä½œ/å¯„å­˜å™¨çŠ¶æ€çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬ç†è§£ä¸º â€œè°ƒè¯•æ¨¡å¼â€ã€‚åœ¨ <code>exec</code> å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è§„å®šæŒ‡ä»¤æ•° &lt;= 100000 æ—¶è¾“å‡ºä¸€äº›æ›´è¯¦ç»†çš„å†…å®¹ï¼Œå¦åˆ™ä¸ºäº†è¾“å‡ºçš„ç®€æ´æ€§å°† verbose è®¾ç½®ä¸º <code>false</code></p>
<p>ä»¥åŠå¾ˆå¿«è¿˜ä¼šè§åˆ°è¿™ä¸¤ä¸ªå‡½æ•°çš„</p>
</details>
<p>å¯¹äºå¦‚ä½•æ‰§è¡Œå•æ¡æŒ‡ä»¤ï¼Œæœ‰ <code>exec_inst</code> å‡½æ•°ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// in nemu/src/cpu/cpu.c</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">exec_inst</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// get the opcode</span>
<span class="w">    </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">   </span><span class="c1">// é€šè¿‡ç¨‹åºè®¡æ•°å™¨è·å–å½“å‰æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span>


<span class="c1">// printf(&quot;opcode = %x, eip = %x\n&quot;, opcode, cpu.eip);  // ä¸€ä¸ªæ’æ¡©æ“ä½œ Instrumentation</span>
<span class="c1">// instruction decode and execution</span>
<span class="cp">#ifdef NEMU_REF_INSTR                   </span><span class="c1">// è¿™é‡Œæœ‰ä¸€ä¸ª â€œå‚è€ƒå®ç°â€ çš„åˆ‡æ¢</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ref_opcode_entry</span><span class="p">[</span><span class="n">opcode</span><span class="p">](</span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">opcode</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opcode_entry</span><span class="p">[</span><span class="n">opcode</span><span class="p">](</span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">opcode</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¿”å›æŒ‡ä»¤é•¿åº¦</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<details class="question">
<summary>è¿™é‡Œé™„å¸¦äº† <code>instr_fetch</code> å‡½æ•°çš„å®ç°</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// in nemu/src/memory/memory.c</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">instr_fetch</span><span class="p">(</span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vaddr_read</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">SREG_CS</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">vaddr_read</span><span class="p">(</span><span class="n">vaddr_t</span><span class="w"> </span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sreg</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">laddr_read</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">laddr_read</span><span class="p">(</span><span class="n">laddr_t</span><span class="w"> </span><span class="n">laddr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">paddr_read</span><span class="p">(</span><span class="n">laddr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">paddr_read</span><span class="p">(</span><span class="n">paddr_t</span><span class="w"> </span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hw_mem_read</span><span class="p">(</span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">hw_mem_read</span><span class="p">(</span><span class="n">paddr_t</span><span class="w"> </span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span><span class="w"> </span><span class="n">hw_mem</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">paddr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>ä¸ºä»€ä¹ˆè¦åµŒå¥—å¤šå±‚å‡½æ•°æœ€ååªæ˜¯ä¸ºäº†æ‰§è¡Œ <code>hw_mem_read</code> è¿™ä¸€æ­¥ï¼Ÿ</p>
<p>è¿™æ˜¯ä¸ºäº†æ¨¡æ‹Ÿ x86-64 çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå‚è§ â€œç‰©ç†åœ°å€ã€è™šæ‹Ÿåœ°å€ã€çº¿æ€§åœ°å€ã€é€»è¾‘åœ°å€â€ è¿™äº›å†…å­˜æ¦‚å¿µ</p>
</details>
<p><code>exec_inst</code> å‡½æ•°å…ˆé€šè¿‡ <code>instr_fetch</code> è·å– opcodeï¼Œç„¶åé€šè¿‡ä¸‹é¢çš„å‡½æ•°è¿›è¡ŒæŒ‡ä»¤æ‰§è¡Œï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opcode_entry</span><span class="p">[</span><span class="n">opcode</span><span class="p">](</span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">opcode</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>è¿™é‡Œ <code>opcode_entry</code> æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œåœ¨ <code>nemu/src/cpu/decode/opcode.c</code> ä¸­æœ‰</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// From nemu/include/cpu/instr_helper.h:</span>
<span class="c1">// typedef int (*instr_func)(uint32_t eip, uint8_t opcode);</span>

<span class="n">instr_func</span><span class="w"> </span><span class="n">opcode_entry</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* ç›®å‰è¿™é‡Œçš„ inv éƒ½æ˜¯å ä½ç¬¦ï¼Œéœ€è¦å…·ä½“å®ç° */</span>
<span class="w">    </span><span class="cm">/* 0x00 - 0x03*/</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* 0x04 - 0x07*/</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* 0x08 - 0x0b*/</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* 0x0c - 0x0f*/</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">opcode_2_byte</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* ... */</span>
<span class="w">    </span><span class="cm">/* 0xf0 - 0xf3*/</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">break_point</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">rep_repe</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* 0xf4 - 0xf7*/</span><span class="w"> </span><span class="n">hlt</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">group_3_b</span><span class="p">,</span><span class="w"> </span><span class="n">group_3_v</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* 0xf8 - 0xfb*/</span><span class="w"> </span><span class="n">clc</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* 0xfc - 0xff*/</span><span class="w"> </span><span class="n">cld</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">group_5_indirect</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
<details class="example">
<summary>å¦‚ä½•ç†è§£ä¸Šé¢çš„å†…å®¹ï¼Ÿ</summary>
<p>é¦–å…ˆæ˜¯ä¸‹é¢çš„ç±»å‹å®šä¹‰ï¼š</p>
<p><code>typedef int (*instr_func)(uint32_t eip, uint8_t opcode);</code></p>
<p>è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª <code>instr_func</code> ç±»å‹ï¼Œè¡¨ç¤ºä¸ºå‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä¸”ä¸“é—¨æŒ‡å‘å‚æ•°ä¸º <code>(uint32_t eip, uint8_t opcode)</code>ï¼Œè¿”å›å€¼ä¸º <code>int</code> çš„å‡½æ•°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ä¾‹ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">instr_func</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op_func</span><span class="p">;</span><span class="w">    </span><span class="c1">// op_func æ˜¯ä¸€ä¸ªç­¾åç¬¦åˆä¸Šè¿°è¦æ±‚çš„å‡½æ•°</span>
<span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">opcode</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>åœ¨å®šä¹‰äº† <code>instr_func</code> åï¼Œæ„å»ºä¸€ä¸ªå­˜å‚¨ <code>instr_func</code> çš„æ•°ç»„ï¼ˆå³ <code>opcode_entry</code>ï¼‰ï¼Œåœ¨ <code>opcode_entry</code> ä¸­æ”¾ç½®å¯¹åº”å‡½æ•°ï¼Œè¿™æ ·é€šè¿‡æ•°ç»„ç´¢å¼•å°±å¯ä»¥åœ¨ O(1) çš„æ—¶é—´å¤æ‚åº¦ä¸‹è·å– opcode å¯¹åº”çš„å‡½æ•°ï¼Œæ¯”å¦‚ï¼š</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">instr_func</span><span class="p">)(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">opcode</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">ADD_rm8_reg8</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">opcode</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// å…·ä½“çš„å‡½æ•°å®ç°...</span>
<span class="p">}</span>
<span class="cm">/* å…¶ä»–å‡½æ•°... */</span>

<span class="n">instr_func</span><span class="w"> </span><span class="n">opcode_entry</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ADD_rm8_reg8</span><span class="p">,</span>
<span class="w">    </span><span class="cm">/* ... */</span>
<span class="p">}</span>

<span class="c1">// ä¸‹é¢çš„æ“ä½œå³å®Œæˆäº†ä¸€æ¬¡æŒ‡ä»¤æ‰§è¡Œ</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">cpu</span><span class="p">.</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opcode_entry</span><span class="p">[</span><span class="n">opcode</span><span class="p">](</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">opcode</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
ï¼ˆå…·ä½“çš„å®ç°å‚è€ƒ NEMU æºä»£ç ï¼‰</p>
</details>
<details class="example">
<summary>å¦‚æœä¸€æ¡æŒ‡ä»¤åŒ…å« <code>0x66</code> å‰ç¼€ï¼Œå¦‚ä½•æ­£ç¡®è¯»å– opcodeï¼Ÿ</summary>
<p>åœ¨ NEMU çš„å®ç°ä¸­ï¼Œ<code>0x66</code> åœ¨ <code>opcode_entry[0x66]</code> ä¸­æœ‰å•ç‹¬çš„æ“ä½œ</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w"> </span><span class="cm">/* 0x64 - 0x67*/</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span><span class="w"> </span><span class="n">data_size_16</span><span class="p">,</span><span class="w"> </span><span class="n">inv</span><span class="p">,</span>
</code></pre></div></td></tr></table></div>
<p>åœ¨ nemu/src/cpu/instr/data_size.c ä¸­æœ‰</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cpu/instr.h&quot;</span>

<span class="k">extern</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span><span class="w">   </span><span class="c1">// è¿™é‡Œæœ‰ä¸€ä¸ªå…¨å±€å˜é‡</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_prefix</span><span class="p">;</span><span class="w">     </span><span class="c1">// åŒä¸Š</span>

<span class="c1">// make_instr_func(data_size_16) æ˜¯ data_size_16(uint32_t eip, uint8_t opcode) çš„å®å°è£…</span>
<span class="c1">// ä¹‹åä¼šæåˆ°</span>
<span class="n">make_instr_func</span><span class="p">(</span><span class="n">data_size_16</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">op_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">    </span><span class="n">has_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">op_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef NEMU_REF_INSTR</span>
<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__ref_opcode_entry</span><span class="p">[</span><span class="n">op_code</span><span class="p">](</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">op_code</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opcode_entry</span><span class="p">[</span><span class="n">op_code</span><span class="p">](</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">op_code</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="n">has_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>ç®€å•æ¥è¯´ï¼Œ<code>0x66</code> è¢«å½“ä½œä¸€æ¡å®Œæ•´çš„æŒ‡ä»¤æ‰§è¡Œï¼ˆè€Œä¸æ˜¯æŸä¸€æ¡æŒ‡ä»¤çš„å‰ç¼€ï¼‰ï¼Œé€šè¿‡å…¨å±€å˜é‡ <code>data_size</code> å’Œ <code>has_prefix</code> ä¼ é€’å‰ç¼€ä¿¡æ¯ï¼ˆå¯¹æ¥ä¸‹æ¥çš„æŒ‡ä»¤æœ‰æ•ˆï¼‰ï¼Œè¿™æ ·å°±å®ç°äº† <code>0x66</code> å‰ç¼€çš„è¯»å–ï¼ŒåŒæ—¶ä¸éœ€è¦ä¸ºæ¯ä¸ªæ“ä½œé¢å¤–åŠ ä¸Š <code>0x66</code> çš„åˆ¤æ–­</p>
</details>
<h2 id="_1">æ¨¡æ‹ŸæŒ‡ä»¤çš„å®ç°</h2>
<div class="admonition quote">
<p class="admonition-title">â€œä¸€æ¡ç®€å•movæŒ‡ä»¤çš„å®ç°â€ çš„éƒ¨åˆ†å¯ä»¥è®¤çœŸçœ‹çœ‹</p>
<p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ï¼š</p>
<ol>
<li>
<p>å®ç°æŒ‡ä»¤ï¼Œä»¥ <code>b1 01: movb $1, %cl</code> ä¸ºä¾‹ï¼š
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">mov_i2r_b</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">opcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// è·å–ç«‹å³æ•°</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">regIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7</span><span class="p">;</span><span class="w">  </span><span class="c1">// è·å–å¯„å­˜å™¨ç¼–å·</span>
<span class="w">    </span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">regIdx</span><span class="p">].</span><span class="n">_8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span><span class="w"> </span><span class="c1">// å®ŒæˆmovåŠ¨ä½œ </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¿”å›æŒ‡ä»¤é•¿åº¦</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>åœ¨ <code>mov.h</code> ä¸­å£°æ˜å‡½æ•°ï¼Œåœ¨ <code>instr.h</code> ä¸­å¼•ç”¨å¤´æ–‡ä»¶ <code>#include "cpu/instr/mov.h"</code></p>
</li>
<li>
<p>åœ¨ <code>opcode.c</code> ä¸­ä¿®æ”¹ opcode_entry ä¸­çš„ç›¸å…³å†…å®¹ï¼Œå®¹æ˜“å¾—åˆ° <code>mov_i2r_b</code> è¿™ä¸ªå‡½æ•°å¯¹ <code>0xB0 ~ 0xB7</code> çš„ opcode éƒ½é€‚ç”¨ï¼Œæ‰€ä»¥æŠŠè¿™å‡ ä¸ªå…ƒç´ çš„ <code>inv</code> éƒ½ä¿®æ”¹ä¸º <code>mov_i2r_b</code> </p>
</li>
</ol>
<p>ä½†æ˜¯äº‹å®ä¸Š mov æŒ‡ä»¤æœ‰å¾ˆå¤šå˜ç§ï¼Œä¸åŒçš„å˜ç§çš„å¤§è‡´æ¡†æ¶æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å¸Œæœ›æŠ½è±¡å‡ºéƒ¨åˆ†ç›¸åŒé€»è¾‘ï¼Œå°è£…æä¾›è°ƒç”¨ï¼Œç®€åŒ–é€»è¾‘</p>
</div>
<p>NEMU ä¸­å¯¹ä¸€äº›å‡½æ•°/ç»“æ„è¿›è¡Œäº†å°è£…ï¼š</p>
<h3 id="_2">æ“ä½œæ•°å’Œæ“ä½œæ•°å¯»å€</h3>
<h4 id="_3">æ“ä½œæ•°çš„å°è£…</h4>
<blockquote>
<p>NEMUä¸­æ‰€æœ‰çš„æ“ä½œæ•°éƒ½å°è£…åœ¨ä¸€ä¸ªå«åš<code>OPERAND</code>çš„æ•°æ®ç»“æ„ä¸­ã€‚è¯¥æ•°æ®ç»“æ„çš„å£°æ˜åœ¨å¤´æ–‡ä»¶<code>nemu/include/cpu/operand.h</code>ä¸­</p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// nemu/include/cpu/operand.h</span>
<span class="cp">#ifndef __OPERAND_H__</span>
<span class="cp">#define __OPERAND_H__</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;nemu.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cpu/cpu.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;memory/memory.h&quot;</span>

<span class="c1">// operand type for immediate number, register, and memory</span>
<span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">OPR_IMM</span><span class="p">,</span><span class="w">   </span><span class="c1">// ç«‹å³æ•°</span>
<span class="w">    </span><span class="n">OPR_REG</span><span class="p">,</span><span class="w">   </span><span class="c1">// å¯„å­˜å™¨</span>
<span class="w">    </span><span class="n">OPR_MEM</span><span class="p">,</span><span class="w">   </span><span class="c1">// å†…å­˜</span>
<span class="w">    </span><span class="n">OPR_CREG</span><span class="p">,</span><span class="w">  </span><span class="c1">// æ§åˆ¶å¯„å­˜å™¨</span>
<span class="w">    </span><span class="n">OPR_SREG</span><span class="w">   </span><span class="c1">// æ®µå¯„å­˜å™¨</span>
<span class="p">};</span>

<span class="cp">#define MEM_ADDR_NA 0xffffffff</span>

<span class="c1">//enum {MEM_ADDR_OFF, MEM_ADDR_SIB};</span>

<span class="c1">// å†…å­˜åœ°å€ç»“æ„ä½“ (MEM_ADDR)</span>
<span class="c1">// æè¿°äº†å†…å­˜çš„å¯»å€æ–¹å¼</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// uint32_t type;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">disp</span><span class="p">;</span><span class="w">  </span><span class="c1">// hex</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">base</span><span class="p">;</span><span class="w">  </span><span class="c1">// register</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"> </span><span class="c1">// register</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1, 2, 4, 8</span>
<span class="p">}</span><span class="w"> </span><span class="n">MEM_ADDR</span><span class="p">;</span><span class="w">         </span><span class="c1">// memory address details</span>

<span class="c1">// æ“ä½œæ•°ç»“æ„ä½“ (OPERAND)</span>
<span class="c1">// åŒ…å«äº†ä¸€ä¸ªæ“ä½œæ•°çš„å®Œæ•´ä¿¡æ¯</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w">           </span><span class="c1">// æ“ä½œæ•°ç±»å‹</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span><span class="w">      </span><span class="c1">// åœ°å€</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sreg</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ®µå¯„å­˜å™¨</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w">       </span><span class="c1">// æ•°æ®å†…å®¹</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span><span class="w">   </span><span class="c1">// æ•°æ®å¤§å°</span>
<span class="w">    </span><span class="n">MEM_ADDR</span><span class="w"> </span><span class="n">mem_addr</span><span class="p">;</span><span class="w">  </span><span class="c1">// å†…å­˜åœ°å€çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬å¯»å€æ–¹å¼ï¼‰</span>
<span class="p">}</span><span class="w"> </span><span class="n">OPERAND</span><span class="p">;</span>

<span class="k">extern</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="n">opr_src</span><span class="p">,</span><span class="w"> </span><span class="n">opr_dest</span><span class="p">;</span>

<span class="c1">// ä»¥ä¸‹æ˜¯å¯¹è¯»å†™ OPERAND çš„ç›¸å…³å°è£…</span>

<span class="c1">// read the operand&#39;s value from its addr</span>
<span class="c1">// ä»æ“ä½œæ•°åœ°å€è¯»å–å€¼</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">operand_read</span><span class="p">(</span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">);</span>

<span class="c1">// write the operand&#39;s value to its addr</span>
<span class="c1">// å°†å€¼å†™å…¥æ“ä½œæ•°åœ°å€</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">operand_write</span><span class="p">(</span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">operand_write_cr0</span><span class="p">(</span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">parse_operand_address</span><span class="p">(</span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">clear_operand_mem_addr</span><span class="p">(</span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">);</span>

<span class="cp">#endif</span>
</code></pre></div></td></tr></table></div>
<p>è¿™æ ·çš„å°è£…è®¾è®¡èƒ½å¤Ÿåº”å¯¹å¤æ‚çš„æ“ä½œæ•°å¯»å€æ¨¡å¼çš„å¤„ç†ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨é‡å†™ <code>mov_i2r_b</code> å‡½æ•°ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">mov_i2r_b</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">opcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">OPERAND</span><span class="w"> </span><span class="n">imm</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w">        </span><span class="c1">// åˆ›å»ºæºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°å±€éƒ¨å˜é‡</span>

<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPR_IMM</span><span class="p">;</span><span class="w">    </span><span class="c1">// é…ç½®æºæ“ä½œæ•°ç±»å‹</span>
<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG_CS</span><span class="p">;</span><span class="w">    </span><span class="c1">// è®¾ç½®æ®µå¯„å­˜å™¨ï¼ŒPA 3-2 å¼€å§‹æ¶‰åŠ</span>
<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c1">// é…ç½®æºæ“ä½œæ•°åœ°å€</span>
<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">     </span><span class="c1">// é…ç½®æºæ“ä½œæ•°é•¿åº¦</span>

<span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="n">data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">        </span><span class="c1">// é…ç½®ç›®çš„æ“ä½œæ•°ç±»å‹</span>
<span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPR_REG</span><span class="p">;</span><span class="w">       </span><span class="c1">// é…ç½®ç›®çš„æ“ä½œæ•°ç±»å‹</span>
<span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7</span><span class="p">;</span><span class="w">  </span><span class="c1">// é…ç½®ç›®çš„æ“ä½œæ•°ç±»å‹</span>

<span class="w">    </span><span class="n">operand_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imm</span><span class="p">);</span><span class="w">   </span><span class="c1">// è¯»æºæ“ä½œæ•°çš„å€¼</span>
<span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imm</span><span class="p">.</span><span class="n">val</span><span class="p">;</span><span class="w">      </span><span class="c1">// å°†æºæ“ä½œæ•°çš„å€¼èµ‹ç»™ç›®çš„æ“ä½œæ•°</span>
<span class="w">    </span><span class="n">operand_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span><span class="w">    </span><span class="c1">// å†™å…¥ç›®çš„æ“ä½œæ•°ï¼Œå®ŒæˆmovåŠ¨ä½œ</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w">             </span><span class="c1">// è¿”å›æŒ‡ä»¤é•¿åº¦</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>è™½ç„¶ä»£ç é‡æ›´å¤§äº†ï¼Œä½†æ˜¯å‡½æ•°çš„è®¾è®¡æ›´åŠ è§„æ•´ï¼Œå¯ä»¥ç”¨è¾ƒä¸ºå›ºå®šåŒ–çš„æ–¹å¼é«˜æ•ˆå®ç°ä¸€ç³»åˆ—çš„ mov å‡½æ•°</p>
<hr />
<p>ç°åœ¨æˆ‘ä»¬è¿›ä¸€æ­¥å®ç° â€œæ“ä½œæ•°å¯»å€â€ çš„ç»†èŠ‚ï¼Œè¿™å…¶ä¸­çš„æ ¸å¿ƒæ˜¯å¯¹ ModR/M å­—æ®µä¸ SIB å­—æ®µçš„è§£æ</p>
<h4 id="modrm">ModR/M</h4>
<p>å›é¡¾ ï¼šModR/M å­—æ®µæ€»å…±åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šMod + Opcode/Reg + R/M</p>
<blockquote>
<p>åœ¨å¤´æ–‡ä»¶<code>nemu/include/cpu/modrm.h</code>ä¸­ï¼Œå£°æ˜äº†<code>ModR/M</code>å­—èŠ‚çš„ç»“æ„å®šä¹‰å’Œå››ä¸ªå‡½æ•°ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">modrm_rm</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rm</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">modrm_r_rm</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rm</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">modrm_opcode_rm</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">opcode</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rm</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">modrm_opcode</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">opcode</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>è¿™å››ä¸ªå‡½æ•°åˆ†åˆ«å¯¹åº”æŒ‡ä»¤å¸Œæœ›é€šè¿‡è§£æ<code>ModR/M</code>å­—èŠ‚æ‰€è·å¾—çš„æ•°æ®çš„å››ç§ä¸åŒç±»å‹ç»„åˆï¼Œå·²æ¶µç›–å®éªŒä¸­æ‰€æ¶‰åŠçš„æ‰€æœ‰æŒ‡ä»¤ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬ä»¥ <code>modrm_r_rm</code> å‡½æ•°ä¸ºä¾‹å…·ä½“åˆ†æï¼Œä¸ºäº†å±•ç¤ºè°ƒç”¨å…³ç³»ï¼Œå°†å†…å±‚å‡½æ•°æ”¾åœ¨äº†æ›´åé¢ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// From modrm.h</span>
<span class="c1">// å¾ˆæ˜¾ç„¶çš„å®šä¹‰</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">reg_opcode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mod</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">MODRM</span><span class="p">;</span>

<span class="c1">// From modrm.c</span>
<span class="c1">// modrm æœ‰å››ç§ç±»å‹ç»„åˆï¼Œè¿™é‡Œåªå±•ç¤º r_rm å‹</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">modrm_r_rm</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">rm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">MODRM</span><span class="w"> </span><span class="n">modrm</span><span class="p">;</span><span class="w">                                </span><span class="c1">// å®šä¹‰ä¸€ä¸ª ModR/M</span>
<span class="w">    </span><span class="n">modrm</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">            </span><span class="c1">// é€šè¿‡ instr_fetch å¡«å……</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPR_REG</span><span class="p">;</span><span class="w">                          </span><span class="c1">// ç¬¬ä¸€ä¸ªæ“ä½œæ•° r ç±»å‹è®¾ç½®ä¸ºâ€œå¯„å­˜å™¨â€</span>
<span class="w">    </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modrm</span><span class="p">.</span><span class="n">reg_opcode</span><span class="p">;</span><span class="w">                 </span><span class="c1">// å…¶åœ°å€è®¾ç½®ä¸º Reg/Opcode å­—æ®µ</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse_rm_32</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">rm</span><span class="p">);</span><span class="w">      </span><span class="c1">// ç¬¬äºŒä¸ªæ“ä½œæ•° rm è°ƒç”¨å‡½æ•°å¤„ç†</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">parse_rm_32</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">MODRM</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// modr/m çš„é•¿åº¦</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
<span class="w">        </span><span class="n">clear_operand_mem_addr</span><span class="p">(</span><span class="n">opr</span><span class="p">);</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">modrm</span><span class="p">.</span><span class="n">mod</span><span class="p">)</span><span class="w">                          </span><span class="c1">// æ ¹æ® mod è®¾ç½® rm </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">case_mod_00</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">opr</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">case_mod_01</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">opr</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">case_mod_10</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">opr</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">case_mod_11</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">opr</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// å››ä¸ª case_mod å‡½æ•°éƒ½å¾ˆç›´ç™½ï¼Œæ­¤å¤„åªå±•ç¤ºå…¶ä¸­ä¸¤ä¸ª</span>
<span class="c1">// Mod = 01ï¼Œå¯¹åº”å¸¦ disp8 åç§»é‡çš„å†…å­˜å¯»å€</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">case_mod_01</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">MODRM</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int8_t</span><span class="w"> </span><span class="n">disp8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">modrm</span><span class="p">.</span><span class="n">rm</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="c1">//disp8 SIB</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPR_MEM</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//len += parse_sib(eip + 1, modrm.mod, &amp;opr-&gt;addr, &amp;opr-&gt;sreg);</span>
<span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">parse_sib</span><span class="p">(</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">modrm</span><span class="p">.</span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">opr</span><span class="p">);</span><span class="w">      </span><span class="c1">// è¿™é‡Œæ˜¯ SIB å­—èŠ‚çš„å¤„ç†</span>
<span class="w">        </span><span class="n">disp8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int8_t</span><span class="p">)</span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// disp8</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="c1">//disp8[EXX]</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPR_MEM</span><span class="p">;</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">modrm</span><span class="p">.</span><span class="n">rm</span><span class="p">].</span><span class="n">_32</span><span class="p">;</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modrm</span><span class="p">.</span><span class="n">rm</span><span class="p">;</span><span class="w">                  </span><span class="c1">// å‚è€ƒ OPERAND çš„ç»“æ„ä½“å®ç°</span>
<span class="w">        </span><span class="n">disp8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int8_t</span><span class="p">)</span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// disp8</span>
<span class="w">        </span><span class="c1">// è¿™é‡Œæ˜¯æ®µå¯„å­˜å™¨çš„æ“ä½œ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">modrm</span><span class="p">.</span><span class="n">rm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="c1">// EBP</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG_SS</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG_DS</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disp8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">int32_t</span><span class="p">)</span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span><span class="w">             </span><span class="c1">// åœ°å€è®¡ç®—</span>
<span class="w">    </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">disp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disp8</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Mod = 11ï¼Œå¯¹åº”ç›´æ¥å¯„å­˜å™¨</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">case_mod_11</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="n">MODRM</span><span class="w"> </span><span class="n">modrm</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPR_REG</span><span class="p">;</span>
<span class="w">    </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modrm</span><span class="p">.</span><span class="n">rm</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="sib">SIB</h4>
<p>å¯¹ SIB å­—èŠ‚çš„ç»“æ„å®šä¹‰<code>nemu/include/cpu/sib.h</code> ä¸å‡½æ•° <code>nemu/src/cpu/decode/sib.c</code> </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// å†…å­˜å¯»å€æ–¹å¼ [Base + Index * Scale + Disp]</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ss</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">SIB</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">parse_sib</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mod</span><span class="p">,</span><span class="w"> </span><span class="n">OPERAND</span><span class="w"> </span><span class="o">*</span><span class="n">opr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">SIB</span><span class="w"> </span><span class="n">sib</span><span class="p">;</span><span class="w">                                    </span><span class="c1">// å®šä¹‰ä¸€ä¸ª SIB</span>
<span class="w">    </span><span class="n">sib</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">              </span><span class="c1">// å–å€¼å¡«å……</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                           </span><span class="c1">// å˜å€å€¼åˆå§‹åŒ–</span>
<span class="w">    </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG_DS</span><span class="p">;</span><span class="w">                        </span><span class="c1">// æ®µå¯„å­˜å™¨é€‰æ‹©</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sib</span><span class="p">.</span><span class="n">base</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sib</span><span class="p">.</span><span class="n">base</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w">         </span><span class="c1">// æ®µå¯„å­˜å™¨é€‰æ‹©</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">sreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG_SS</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/* ç‰¹ä¾‹ï¼šå½“ Index = 100 æ—¶ï¼Œçœ‹ä½œâ€œIndex = NULLâ€ï¼ˆä¸ä½¿ç”¨å˜å€å¯„å­˜å™¨ï¼‰ï¼Œè€Œä¸æ˜¯ â€œIndex = ESPâ€ */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sib</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w">                         </span><span class="c1">// å¯ç”¨äº†å˜å€å¯„å­˜å™¨</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">sib</span><span class="p">.</span><span class="n">index</span><span class="p">].</span><span class="n">_32</span><span class="p">;</span><span class="w">           </span><span class="c1">// è·å–å˜å€å¯„å­˜å™¨çš„ 32 ä½å€¼</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sib</span><span class="p">.</span><span class="n">index</span><span class="p">;</span><span class="w">        </span><span class="c1">// è®°å½•å˜å€å¯„å­˜å™¨çš„ id</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">sib</span><span class="p">.</span><span class="n">ss</span><span class="p">)</span><span class="w">                         </span><span class="c1">// ç¼©æ”¾å› å­</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x0</span><span class="p">:</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x1</span><span class="p">:</span>
<span class="w">            </span><span class="n">idx</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x2</span><span class="p">:</span>
<span class="w">            </span><span class="n">idx</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mh">0x3</span><span class="p">:</span>
<span class="w">            </span><span class="n">idx</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mod</span><span class="p">)</span><span class="w">                                </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="c1">// only now has additional disp32?</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sib</span><span class="p">.</span><span class="n">base</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">        </span><span class="cm">/* ç‰¹ä¾‹ï¼šå½“ Base = 101 ä¸” Mod = 00 æ—¶ï¼Œçœ‹ä½œâ€œBase = NULLâ€ï¼ˆä¸ä½¿ç”¨åŸºå€å¯„å­˜å™¨ï¼‰ï¼Œè€Œä¸æ˜¯ â€œBase = EBPâ€ï¼ŒåŒæ—¶å¯ç”¨ Disp32 */</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">disp32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instr_fetch</span><span class="p">(</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">disp32</span><span class="p">;</span>
<span class="w">            </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">disp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">disp32</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">        </span><span class="c1">// æ­£å¸¸æƒ…å†µä¸‹</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">sib</span><span class="p">.</span><span class="n">base</span><span class="p">].</span><span class="n">_32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span>
<span class="w">        </span><span class="n">opr</span><span class="o">-&gt;</span><span class="n">mem_addr</span><span class="p">.</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sib</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;illegal mod=11 in SIB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_4">è¿›ä¸€æ­¥çš„å°è£…</h3>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª <code>mov_i2rm_v</code> æŒ‡ä»¤ ï¼ˆå°†ä¸€ä¸ªç«‹å³æ•° <code>mov</code> åˆ°ä¸€ä¸ªç”± <code>ModR/M</code> å­—èŠ‚æ‰€è¡¨è¾¾çš„å¯„å­˜å™¨æˆ–å†…å­˜åœ°å€ï¼ˆR/Mï¼‰ä¸­ï¼Œä½æ•°ä¸å®šï¼‰</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">mov_i2rm_v</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">eip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">opcode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">OPERAND</span><span class="w"> </span><span class="n">rm</span><span class="p">,</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>

<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rm</span><span class="p">.</span><span class="n">data_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span><span class="w"> </span><span class="c1">// è§£ç æ“ä½œæ•°ï¼šæŒ‡å®šæ“ä½œæ•°é•¿åº¦</span>
<span class="w">                                              </span><span class="c1">// data_size ä¼šå—åˆ° 0x66 çš„å½±å“</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">modrm_rm</span><span class="p">(</span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rm</span><span class="p">);</span><span class="w">            </span><span class="c1">// è§£ç æ“ä½œæ•°ï¼šæ“ä½œæ•°å¯»å€</span>
<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OPR_IMM</span><span class="p">;</span>
<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">sreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SREG_CS</span><span class="p">;</span>
<span class="w">    </span><span class="n">imm</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">    </span><span class="n">operand_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imm</span><span class="p">);</span><span class="w">                       </span><span class="c1">// movæ“ä½œ</span>
<span class="w">    </span><span class="n">rm</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imm</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
<span class="w">    </span><span class="n">operand_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rm</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w">               </span><span class="c1">// è¿”å›é•¿åº¦</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>ä»¥è¿™ä¸ªä¸¤æ“ä½œæ•°çš„æŒ‡ä»¤ä¸ºä¾‹ï¼Œè¿›è¡Œè¿›ä¸€æ­¥çš„å°è£…ã€ç®€åŒ–æ“ä½œï¼š</p>
<div class="admonition question">
<p class="admonition-title">å‰ç½®çŸ¥è¯†ï¼š<code>concat</code> å®</p>
<p>concat ç³»åˆ—å®å¯ä»¥å°†å¤šä¸ªå‚æ•°ç¡¬æ‹¼æ¥ä½¿ç”¨ï¼Œåœ¨ <code>nemu/include/macro.h</code> ä¸­æœ‰ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#define concat_temp(x, y) x##y</span>
<span class="cp">#define concat(x, y) concat_temp(x, y)</span>
<span class="cp">#define concat3(x, y, z) concat(concat(x, y), z)</span>
<span class="cp">#define concat4(x, y, z, w) concat3(concat(x, y), z, w)</span>
<span class="cp">#define concat5(x, y, z, v, w) concat4(concat(x, y), z, v, w)</span>
<span class="cp">#define concat6(x, y, z, v, w, u) concat5(concat(x, y), z, v, w, u)</span>
<span class="cp">#define concat7(x, y, z, v, w, u, h) concat6(concat(x, y), z, v, w, u, h)</span>
</code></pre></div></td></tr></table></div>
<p>ç”±äºå®æ“ä½œçš„ç‰¹æ€§ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ‹¼æ¥å‡½æ•°åï¼š</p>
<p>æ¯”å¦‚ <code>make_instr_func(mov_i2rm_v)</code>ï¼Œå¯ä»¥å†™æˆ</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">make_instr_func</span><span class="p">(</span><span class="n">concat7</span><span class="p">(</span><span class="n">mov</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">rm</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
<p>ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„ä½¿ç”¨ä¾‹</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#define make_instr_impl_2op(inst_name, src_type, dest_type, suffix)    \</span>
<span class="cp">    make_instr_func(concat7(inst_name, _, src_type, 2, dest_type, _, suffix))</span>
</code></pre></div></td></tr></table></div>
<p>è¿™ç§å®å±•å¼€åŒ¹é…å‡½æ•°åçš„æ–¹å¼å¯ä»¥æå¤§çš„ç®€åŒ–åˆ†æ”¯æ“ä½œ</p>
</div>
<ul>
<li>æ‰€æœ‰çš„æŒ‡ä»¤çš„ç­¾åéƒ½æ˜¯ä¸€æ ·çš„ï¼ˆç¬¦åˆ <code>opcode_entry</code> çš„è¦æ±‚ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–å‡½æ•°å£°æ˜ï¼š</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// From nemu/include/cpu/instr_helper.h</span>
<span class="c1">// macro for making an instruction entry</span>
<span class="cp">#define make_instr_func(name) int name(uint32_t eip, uint8_t opcode)</span>
</code></pre></div></td></tr></table></div>
<p>æ­¤æ—¶ <code>int mov_i2rm_v(uint32_t eip, uint8_t opcode)</code> å¯ä»¥é‡å†™ä¸º <code>make_instr_func(mov_i2rm_v)</code> </p>
<ul>
<li>NEMU ä¸å­˜åœ¨æŒ‡ä»¤å¹¶å‘ï¼Œæ‰€ä»¥å¯ä»¥å°†æŒ‡ä»¤çš„æ“ä½œæ•°ä¿®æ”¹ä¸ºå…¨å±€å˜é‡ï¼Œè§„èŒƒå‘½åå¹¶ä¸”èŠ‚çœæ ˆç©ºé—´</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// From nemu/src/cpu/decode/operand.c</span>
<span class="n">OPERAND</span><span class="w"> </span><span class="n">opr_src</span><span class="p">,</span><span class="w"> </span><span class="n">opr_dest</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ä¸éš¾å‘ç°ï¼Œå¯¹äºå¾ˆå¤šä¸¤æ“ä½œæ•°æŒ‡ä»¤ï¼Œéƒ½æ»¡è¶³ä¸‹é¢çš„æ­¥éª¤ï¼šè§£ç ä¸¤ä¸ªæ“ä½œæ•° -&gt; è¿›è¡Œå®é™…çš„æŒ‡ä»¤æ“ä½œï¼ˆæ¯”å¦‚movï¼‰ -&gt; è¿”å›æŒ‡ä»¤é•¿åº¦</li>
</ul>
<p>è¿™è®©æˆ‘ä»¬å°è¯•ç»Ÿä¸€æ‰€æœ‰ç¬¦åˆä¸Šè¿°è§„åˆ™çš„å‡½æ•°ï¼š</p>
<p>Â·Â·Â· è¿™äº›æŒ‡ä»¤çš„åå­—éƒ½ç¬¦åˆ <code>"inst_name"_"src_type"'2'"dest_type"_"suffix"</code> çš„å‘½åè§„èŒƒï¼ˆæ¯”å¦‚ <code>mov_i2rm_v</code>ï¼‰ï¼Œå› æ­¤æˆ‘å¯ä»¥æ„é€ ä¸€ä¸ª <code>make_instr_impl_2op(inst_name, src_type, dest_type, suffix)</code> çš„å¤§æ¡†æ¶ï¼Œé€šè¿‡è¾“å…¥å„ä¸ªå‚æ•°çš„å†…å®¹å°±å¯ä»¥æ˜ å°„åˆ°å¯¹åº”çš„ä¸¤æ“ä½œæ•°æŒ‡ä»¤ï¼ˆå€ŸåŠ© <code>concat</code> å®å®ç°ï¼‰</p>
<p>Â·Â·Â· æ¥ä¸‹æ¥å®ç°ä¸¤ä¸ªè§£ç æ“ä½œæ•°çš„å‡½æ•°å°è£…ï¼ˆåˆ†åˆ«æ˜¯æ“ä½œæ•°é•¿åº¦ä¸æ“ä½œæ•°å¯»å€çš„å‡½æ•°ï¼‰</p>
<p>Â·Â·Â· ç„¶åä¸€ä¸ªé™å®šåœ¨å•ä¸ªæ–‡ä»¶å†…çš„ <code>static instr_execute_2op();</code> å‡½æ•°ï¼Œåœ¨æ¯ä¸ªæ–‡ä»¶å†…ï¼ˆä»£è¡¨ä¸€ä¸ªç±»å‹çš„æŒ‡ä»¤ï¼‰åˆ†åˆ«æŒ‡ä»£åŒä¸€ç§æ“ä½œ</p>
<p>Â·Â·Â· æœ€åç»Ÿä¸€è¿”å›é•¿åº¦</p>
<p>åœ¨ <code>instr_helper.h</code> ä¸­ï¼Œæˆ‘ä»¬æœ‰äº†å¯¹åº”çš„å®ç°ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// ä¸€ä¸ªå®ç°éƒ¨åˆ†ä¸¤æ“ä½œæ•°æŒ‡ä»¤çš„æ¨¡æ¿</span>
<span class="c1">// decode_data_size ä¸ decode_operand ç³»åˆ—çš„æŒ‡ä»¤ä¹Ÿåœ¨ instr_helper.h ä¸­å®ç°ï¼Œè‡ªè¡Œåˆ†æ</span>

<span class="c1">// macro for generating the implementation of an instruction with two operands</span>
<span class="cp">#define make_instr_impl_2op(inst_name, src_type, dest_type, suffix)                                                                        \</span>
<span class="cp"> make_instr_func(concat7(inst_name, _, src_type, 2, dest_type, _, suffix))                                                              \</span>
<span class="cp"> {                                                                                                                                      \</span>
<span class="cp">     int len = 1;                                                                                                                       \</span>
<span class="cp">     concat(decode_data_size_, suffix)                                                                                                  \</span>
<span class="cp">     concat3(decode_operand, _, concat3(src_type, 2, dest_type))                                                                    \</span>
<span class="cp">     print_asm_2(#inst_name, opr_dest.data_size == 8 ? &quot;b&quot; : (opr_dest.data_size == 16 ? &quot;w&quot; : &quot;l&quot;), len, &amp;opr_src, &amp;opr_dest); \</span>
<span class="cp">     instr_execute_2op();                                                                                                               \</span>
<span class="cp">     return len;                                                                                                                        \</span>
<span class="cp"> }</span>
</code></pre></div></td></tr></table></div>
<p>å¯¹äº <code>mov</code> ç³»æŒ‡ä»¤ï¼Œæˆ‘ä»¬æœ€ç»ˆæœ‰ä¸‹é¢çš„å†™æ³•ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// æ‰€æœ‰movæŒ‡ä»¤å…±äº«çš„æ‰§è¡Œæ–¹æ³•</span>
<span class="c1">// static ä½¿å¾— instr_execute_2op() åªä¼šåœ¨ mov.c ä¸­ç”Ÿæ•ˆï¼Œå®ç°éš”ç¦»</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">instr_execute_2op</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">operand_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opr_src</span><span class="p">);</span>
<span class="w">    </span><span class="n">opr_dest</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">opr_src</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
<span class="w">    </span><span class="n">operand_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opr_dest</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// è¿™é‡Œçš„æ¯ä¸€è¡ŒæŒ‡ä»¤åœ¨å®å±•å¼€åéƒ½æ˜¯å®Œæ•´çš„å®ç°</span>
<span class="n">make_instr_impl_2op</span><span class="p">(</span><span class="n">mov</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">rm</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="n">make_instr_impl_2op</span><span class="p">(</span><span class="n">mov</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">rm</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span>
<span class="n">make_instr_impl_2op</span><span class="p">(</span><span class="n">mov</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">rm</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span>
<span class="n">make_instr_impl_2op</span><span class="p">(</span><span class="n">mov</span><span class="p">,</span><span class="w"> </span><span class="n">rm</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div></td></tr></table></div>
<p><code>mov</code> å‡½æ•°çš„ä¸»è¦å®ç°å·²ç»åœ¨ <code>mov.c</code> ä¸­å®Œæˆï¼Œä½œä¸ºä¸¾ä¾‹</p>
<hr />
<p>åœ¨ <code>instr_helper.h</code> ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€æ“ä½œæ•°/ä¸¤æ“ä½œæ•°æŒ‡ä»¤çš„å®Œæ•´é€»è¾‘ï¼ˆæ»¡è¶³<strong>å–æ•° -&gt; æ‰§è¡Œ -&gt; è¿”å›é•¿åº¦</strong>çš„æŒ‡ä»¤ï¼‰ï¼ŒåŒæ—¶å¯¹ <code>jcc</code> ç³»æŒ‡ä»¤ä¹Ÿæœ‰äº†ç›¸å¯¹åº”çš„ <code>cc</code> ç‰ˆå®å®ç°</p>
<blockquote>
<p>æ ¹æ®æ¡†æ¶ä»£ç çš„æ„ç­‘ç»éªŒï¼Œé€‚ç”¨å’Œä¸é€‚ç”¨å®çš„æŒ‡ä»¤åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>
<p>é€‚ç”¨å®çš„æŒ‡ä»¤ï¼š<code>adc</code>, <code>add</code>, <code>and</code>, <code>bt</code>, <code>cbw</code>, <code>cmov</code>, <code>cmp</code>, <code>dec</code>, <code>inc</code>, <code>jcc</code>, å¤§å¤šæ•°çš„<code>mov</code>, <code>not</code>, <code>or</code>, <code>pop</code>, <code>push</code>, <code>sar</code>, <code>sbb</code>, <code>setcc</code>, <code>shl</code>, <code>shr</code>, <code>sub</code>, <code>test</code>, <code>xor</code></p>
</li>
<li>
<p>ä¸é€‚ç”¨çš„æŒ‡ä»¤ï¼š<code>call</code>, <code>cltd</code>, <code>cmps</code>, <code>div</code>, <code>idiv</code>, <code>mul</code>, <code>imul</code>, <code>cld</code>, <code>clc</code>, <code>sahf</code>, <code>hlt</code>, <code>int</code>, <code>jmp</code>, <code>lea</code>, <code>leave</code>, <code>rep</code>, <code>ret</code>, <code>stos</code>, <code>x87</code></p>
</li>
</ul>
</blockquote>
<h2 id="-">---åˆ†éš”çº¿---</h2>
<h2 id="tips-when-completing-pa">Tips when completing PA</h2>
<div class="admonition success">
<p class="admonition-title">ä¸ºé˜²æ­¢å‰§é€ï¼Œå‡ ä¹æ‰€æœ‰çš„ Tips éƒ½è¢«æŠ˜å </p>
<p>ï¼ˆTips æŒ‡çš„æ˜¯æœ¬äººåœ¨å®é™…å®Œæˆ PA æ—¶è®¤ä¸ºæœ‰æ¨åŠ¨æ€§å¸®åŠ©çš„ç‚¹ï¼‰</p>
</div>
<details class="tip" open="open">
<summary>è€å¸ˆç»™å‡ºçš„æœ‰å…³ pop / push å®ç°çš„å»ºè®®</summary>
<blockquote>
<p><code>push</code> å’Œ <code>pop</code> å»ºè®®ä¸ç®¡ <code>data_size</code>åŸæ¥æ˜¯å¤šå°‘ï¼Œéƒ½æ‰©å±•åˆ° 32 ä½å†æ“ä½œ</p>
</blockquote>
</details>
<details class="tip">
<summary>å…³äºå¡«å†™ <code>opcode_entry</code> / å‡½æ•°åå¦‚ä½•å‘½å / æˆ‘éœ€è¦å®ç°å“ªäº›å°å‡½æ•°çš„é—®é¢˜</summary>
<p>åœ¨ <code>opcode.c</code> æ–‡ä»¶çš„åŒçº§ç›®å½•ä¸‹æœ‰ä¸€ä¸ª <code>opcode_ref.c</code> æ–‡ä»¶ï¼Œä½ ä¼šå‘ç°åˆ é™¤æ‰€æœ‰çš„ <code>__ref_</code> åï¼Œå…¶ä½™çš„å†…å®¹å°±æ˜¯ä½ éœ€è¦åœ¨ <code>opcode.c</code> ä¸­å¡«å†™çš„å†…å®¹</p>
<p>ä½ åªéœ€è¦é€‰æ‹©æ€§çš„ Ctrl C+Vï¼Œç„¶å Ctrl+F åˆ æ‰å°±èƒ½è·å¾—ä¸€ä¸ªå¤§è‡´å¡«å†™å®Œæˆçš„ <code>opcode.c</code> æ–‡ä»¶ï¼ŒåŒæ—¶è¿˜é™„èµ äº†ä½ éœ€è¦å…·ä½“å®ç°çš„æ¯ä¸€ä¸ªå­å‡½æ•°çš„åç§°</p>
<p><strong>æ³¨æ„ä½ ä¸åº”è¯¥ä¸€æ¬¡å¤åˆ¶æ•´ä¸ª <code>opcode_ref.c</code>ï¼Œä½ å¤åˆ¶çš„å‡½æ•°éƒ½éœ€è¦è¢«å®ç°æ‰èƒ½é€šè¿‡ç¼–è¯‘</strong>ï¼Œä½ åº”è¯¥åªå¤åˆ¶å®ç°çš„éƒ¨åˆ†</p>
<p>å¦å¤–ï¼šå¯¹äº PA 2-1ï¼Œä½ ä¸éœ€è¦å®ç°æ‰€æœ‰çš„å‡½æ•°ï¼Œæ‰€ä»¥éƒ¨åˆ†å‡½æ•°ä½¿ç”¨ <code>__ref_</code> ç‰ˆæœ¬ä¸å½±å“å®Œæˆ</p>
</details>
<details class="tip">
<summary>ç¼–è¯‘æ—¶å‡ºç°äº† <code>./include/cpu/instr_helper.h:14:31: error: expected '=', ',', ';', 'asm' or '__attribute__' before 'int'</code> ä¹‹ç±»çš„æŠ¥é”™ï¼Ÿ</summary>
<p><code>/nemu/src/cpu/instr</code> é‡Œé¢çš„æ¯ä¸€é¡¹å¤´æ–‡ä»¶éƒ½æ£€æŸ¥ä¸€ä¸‹ <code>make_instr_func();</code> æœ‰æ²¡æœ‰æ¼åŠ åˆ†å·</p>
<p>ç”±äºå®å±•å¼€çš„ç¥ç§˜ç‰¹æ€§ï¼ŒæŠ¥é”™æ‰€åœ¨çš„æ–‡ä»¶ä½ç½®ä¸ä¸€å®šæ­£ç¡®</p>
<p>ä¸ªäººç»å†ï¼šâ€œ<code>push.h</code> æ²¡åŠ åˆ†å·æ€ä¹ˆæŠ¥é”™æŠ¥åœ¨äº† <code>div.h</code> ğŸ˜¨â€ï¼ˆå‘é€äºå‡Œæ™¨ä¸‰ç‚¹ï¼‰</p>
</details>
<details class="tip">
<summary>æˆ‘åœ¨æŸä¸€ä¸ª testcase å‡ºç°äº† <strong>HIT <font color="#FF0000">BAD</font> TRAP</strong>ï¼Œä½†æ˜¯æˆ‘å¹¶ä¸çŸ¥é“è‡ªå·±çš„å‡½æ•°å®ç°ä¸­æœ‰å“ªäº›é”™è¯¯ï¼Œå¦‚ä½•æ’æŸ¥</summary>
<p>æ¯ä¸€ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ª <code>__ref_</code> ç‰ˆæœ¬çš„æ ‡å‡†å®ç°ã€‚å¦‚æœä½ å¤§æ¦‚èƒ½ç¡®å®šå¯èƒ½æ˜¯å“ªä¸€æ¡æŒ‡ä»¤å‡ºäº†é—®é¢˜ï¼Œå°±å°†å®ƒåœ¨ <code>opcode_entry[]</code> ä¸­åŠ ä¸Š <code>__ref_</code>ï¼Œå¦‚æœå†æ¬¡æµ‹è¯•ï¼ˆè®°å¾—å…ˆ <code>make</code>ï¼‰å‘ç° <strong>HIT <font color="#00FF00">GOOD</font> TRAP</strong>ï¼Œè¯´æ˜ä½ åˆšåˆšåŠ ä¸Š <code>__ref_</code> çš„æŒ‡ä»¤çš„å®ç°æœ‰é—®é¢˜ï¼›</p>
<p>å¦‚æœä½ ä¸æ¸…æ¥šå“ªä¸€æ¡æŒ‡ä»¤å‡ºäº†é—®é¢˜ï¼Œé‚£å°±å°†æ‰€æœ‰æ¶‰åŠåˆ°è¿™ä¸ªæ ·ä¾‹çš„æŒ‡ä»¤å…¨éƒ¨åŠ ä¸Š <code>__ref_</code>ï¼Œä¸€ä¸ªä¸ªè§£é™¤ <code>__ref_</code>ï¼Œç›´åˆ°å‡ºç° <strong>HIT <font color="#FF0000">BAD</font> TRAP</strong>ï¼Œè¯´æ˜æœ€åä¸€ä¸ªè§£é™¤ <code>__ref_</code> çš„å‡½æ•°å®ç°æœ‰é—®é¢˜</p>
</details>
<details class="tip">
<summary>æˆ‘åœ¨æŸä¸€ä¸ª testcase å‡ºç°äº† <code>invalid opcode</code> æŠ¥é”™</summary>
<p>å¦‚æœè¿™ä¸ª opcode æ˜¯é¢„æœŸçš„ï¼Œæ£€æŸ¥ <code>opcode_entry[]</code> æ˜¯å¦å¿˜è®°æ·»åŠ å‡½æ•°</p>
<p>å¦‚æœè¿™ä¸ª opcode ä¸æ˜¯é¢„æœŸçš„ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æ˜¯å…¶ä»–æŒ‡ä»¤çš„å®ç°æœ‰é—®é¢˜ï¼ˆæ¯”å¦‚è¿”å›äº†é”™è¯¯çš„ <code>len</code>ï¼‰ã€‚ä½ å¯ä»¥ç”¨ä¸Šé¢ä¸€æ¡æåˆ°çš„ <code>__ref_</code> æ–¹æ¡ˆå°è¯•æ‰¾åˆ°é”™è¯¯çš„å‡½æ•°ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ monitor çš„å•æ­¥æ‰§è¡Œæ“ä½œï¼Œå®šä½å‡ºç° <code>invalid opcode</code> å‰æœ€åæ‰§è¡Œçš„ opcode</p>
<p>ï¼ˆä¸ªäººç»å†ï¼šæˆ‘åœ¨å®ç° <code>and</code> å‡½æ•°æ—¶æ²¡æœ‰æ³¨æ„ç¬¦å·æ‰©å±•ï¼Œå¯¼è‡´ <code>quick-sort</code> æµ‹è¯•ç‚¹å‡ºç°æ•°å€¼æº¢å‡ºï¼Œåœ°å€åœ¨å°†è¿‘ 1w æ­¥æ‰§è¡Œåç›´æ¥è·³è½¬åˆ°äº† <code>0x0</code> å·¦å³çš„ä½ç½®ï¼Œå¹¶æœ€ç»ˆ <code>invalid opcode</code> ã€‚åœ¨è¿™ä¸ªä¸å¸¸è§çš„ç»å†ä¸­ï¼Œ<code>__ref_</code> æ˜¯æœ€ç›´æ¥çš„æ’æŸ¥æ–¹æ¡ˆï¼‰</p>
</details>
<details class="tip">
<summary>æˆ‘å°†å…¨éƒ¨çš„æŒ‡ä»¤éƒ½ <code>__ref_</code> äº†ï¼Œä½†æ˜¯ä¾æ—§ <strong>HIT <font color="#FF0000">BAD</font> TRAP</strong></summary>
<p>è¿™ä¸åº”è¯¥ï¼Œæ ¹æ®æµ‹è¯•ï¼Œå…¨éƒ¨ä½¿ç”¨å‚è€ƒå®ç°å¯ä»¥é€šè¿‡æ‰€æœ‰çš„ testcasesï¼ˆ<code>test-float</code> é™¤å¤–ï¼‰</p>
<p><del>éœ€è¦æ€è€ƒè‡ªå·±æ˜¯ä¸æ˜¯åŠ¨è¿‡ä¸è¯¥åŠ¨çš„ä¸œè¥¿äº†</del>ï¼Œæˆ–è€…å†æ¬¡ç¡®è®¤æœ‰æ²¡æœ‰å¿˜è®° <code>__ref_</code> åŒ–çš„å‡½æ•°</p>
</details>
<details class="tip">
<summary>æˆ‘åœ¨ <code>make</code> æ—¶æ²¡æœ‰çœ‹åˆ°çº¢è‰²çš„ç¼–è¯‘æŠ¥é”™ä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘åœ¨è°ƒç”¨ nemu è¿›è¡Œ test æ—¶å‘ç° <code>command not found</code>ï¼Œæ²¡æœ‰ç”Ÿæˆ nemu å¯æ‰§è¡Œæ–‡ä»¶</summary>
<p>è¯´æ˜ <code>make</code> ç¡®å®æ²¡æœ‰ç¼–è¯‘é—®é¢˜ï¼Œä½†æ˜¯å¯èƒ½<strong>å­˜åœ¨é“¾æ¥é—®é¢˜</strong>ï¼Œæ­¤æ—¶ä¸ä¼šæœ‰çº¢è‰²çš„æŠ¥é”™ï¼Œè€Œæ˜¯æ­£å¸¸é¢œè‰²ï¼Œæ··åœ¨æ­£å¸¸çš„ç¼–è¯‘ä¿¡æ¯ä¸­ï¼Œæ¯”å¦‚ï¼š</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>undefined reference to &#39;xxx&#39;
collect2: error: ld returned 1 exit status
make-[1]: *** [Makefile:13: nemu] Error 1
</code></pre></div></td></tr></table></div>
<p>ä¸Šé¢çš„ä¾‹å­è¯´æ˜ä½ å£°æ˜äº†ä¸€ä¸ªå‡½æ•°ä½†æ˜¯ä»æ¥æ²¡æœ‰å®ç°å®ƒï¼Œè¿™æ˜¯ä¸€ä¸ªé“¾æ¥é˜¶æ®µçš„é”™è¯¯ï¼Œè€Œä¸æ˜¯ç¼–è¯‘é˜¶æ®µçš„é”™è¯¯ï¼Œæ‰€ä»¥æ²¡æœ‰å½©è‰²çš„æŠ¥é”™æç¤º</p>
</details>
<details class="tip">
<summary>ä¸ºä»€ä¹ˆæˆ‘æ²¡æœ‰ä½¿ç”¨ <code>__ref_</code> å®ŒæˆæŒ‡ä»¤ï¼ŒæŸä¸ª testcase ä¾æ—§æé†’ â€œ<font color="#FF0000">You have used reference implementation, DO NOT submit this version.</font>â€</summary>
<p>é¦–å…ˆç¡®è®¤ä¸€ä¸‹è‡ªå·±æ˜¯ä¸æ˜¯çœŸçš„åœ¨è¿™ä¸ª testcase æ‰€éœ€è¦çš„æŒ‡ä»¤ä¸­å®Œå…¨æ²¡æœ‰ä½¿ç”¨ <code>__ref_</code> </p>
<p>ç„¶åå¼•ç”¨è€å¸ˆçš„è§£ç­”ï¼š</p>
<blockquote>
<p>è¿™ä¸€èˆ¬æ˜¯å› ä¸ºæŸæ•´æ•°è¿ç®—ç›¸å…³çš„æŒ‡ä»¤ï¼Œå½“é‡åˆ°ä¸¤ä¸ªæ“ä½œæ•°é•¿åº¦ä¸ä¸€æ ·çš„æ—¶å€™ï¼Œæ²¡æœ‰åœ¨è°ƒç”¨aluå¯¹åº”è¿ç®—å‡½æ•°å‰å…ˆç»Ÿä¸€æ“ä½œæ•°é•¿åº¦å¯¼è‡´çš„</p>
<p>ç»Ÿä¸€çš„æ—¶å€™è¦ç”¨sign_extå‡½æ•°åšç¬¦å·æ‰©å±•</p>
</blockquote>
</details>
<details class="tip">
<summary>æ ·ä¾‹æµ‹è¯•çš„æ—¶å€™å‡ºç°äº† <code>load_exec: Assertion 'fp != 0' failed</code></summary>
<p>æ„æ€æ˜¯ nemu æ²¡æœ‰æ‰¾åˆ°æ ·ä¾‹æ–‡ä»¶</p>
<p>è¯´æ˜ä½ æŠŠæ ·ä¾‹çš„åå­—è¾“é”™äº†ï¼ˆåº”è¯¥æ²¡æœ‰åç¼€åï¼‰/ ä½ æ‰‹æ“äº†ä¸€ä¸ªæ ·ä¾‹ä½†æ˜¯æ²¡æœ‰ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</p>
</details>
<details class="tip">
<summary>ä¸å¥½å¥‡ä¸€ä¸‹ <code>__ref_</code> æ˜¯å¦‚ä½•å®ç°çš„å—</summary>
<p>åœ¨ <code>libs/nemu-ref/lib-nemu-ref.a</code> ä¸­ï¼ˆ<code>.a</code> æ–‡ä»¶å¯ä»¥çœ‹ä½œå¤šä¸ª <code>.o</code> æ–‡ä»¶çš„æ‰“åŒ…æ–‡ä»¶ï¼‰æœ‰æ¯ä¸ª <code>__ref_</code> å‡½æ•°çš„å®ç°ï¼Œä½ å¯ä»¥ç”¨é€†å‘å·¥å…·å°†å…¶åæ±‡ç¼–ä¸ºæ±‡ç¼–è¯­è¨€/åç¼–è¯‘ä¸º C è¯­è¨€</p>
<p>å¯ä»¥åç¼–è¯‘ <code>__ref_</code> å‡½æ•°æ¥äº†è§£æŸä¸ªå‡½æ•°çš„å®ç°æ–¹å¼ï¼Œè™½ç„¶éå¸¸ä¸ç›´è§‚</p>
<p><img src="https://img.cdn1.vip/i/68ef094475a2c_1760495940.webp" alt="image.png"></p>
</details>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../stylesheets/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>